frappe.ui.form.on("Job Applicant", {
    onload: function (frm) {
        // ✅ 1. Fetch Job Opening and store interview rounds
        if (frm.doc.job_title) {
            let job_opening_id = frm.doc.job_title;

            frappe.call({
                method: "frappe.client.get",
                args: {
                    doctype: "Job Opening",
                    name: job_opening_id
                },
                callback: function (r) {
                    if (r.message) {
                        frm.custom_interview_rounds = r.message.custom_interview_rounds || [];
                    }
                }
            });
        }

        // ✅ 2. Override create_dialog instead of override_create_dialog
        frm.events.create_dialog = function (frm) {
            if (!frm.custom_interview_rounds || frm.custom_interview_rounds.length === 0) {
                frappe.msgprint("No Interview Rounds found for selected Job Opening.");
                return;
            }

            let round_options = [];
            let round_map = {};

            frm.custom_interview_rounds.forEach(row => {
                 let label = `${row.round_name}`;
                round_options.push(label);
                round_map[label] = row;
            });

            let dialog = new frappe.ui.Dialog({
                title: "Enter Interview Round",
                fields: [
                    {
                        label: "Interview Round",
                        fieldname: "round_name",
                        fieldtype: "Select",
                        options: round_options,
                        reqd: 1
                    }
                    // {
                    //     label: "Interview Date",
                    //     fieldname: "interview_date",
                    //     fieldtype: "Date",
                    //     reqd: 1
                    // }
                ],
                primary_action_label: "Create Interview",
                primary_action(values) {
                    let selected_row = round_map[values.round_name];
                    frappe.call({
                        method: "frappe.client.insert",
                        args: {
                            doc: {
                                doctype: "Interview",
                                job_applicant: frm.doc.name,
                                applicant_name: frm.doc.applicant_name,
                                job_opening: frm.doc.job_title,
                                designation: frm.doc.designation,
                                round_name: selected_row.round_name,
                                // interview_date: values.interview_date
                            }
                        },
                        callback: function (res) {
                            if (res.message) {
                                frappe.set_route("Form", "Interview", res.message.name);
                                frappe.msgprint("✅ Interview Created Successfully");
                            }
                        }
                    });

                    dialog.hide();
                }
            });

            dialog.show();
        };
    }
});

